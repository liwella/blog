---
title: 分布式事务基础理论
date: 2022-12-27 21:50:41
author: 青蛙瓷器
img: http://pic.tanzhang.work/blog/gallary/221223.jpg
top: false
cover: false
coverImg: 
toc: true
mathjax: false
categories: 分布式
tags:
  - 事务
---
微服务的出现解决了单体架构的痛点和难点，同时也引入了一些新的问题，服务如何治理、通信、服务划分以及服务间数据的一致性等等，都会影响到微服务架构的成败。本节讨论的是如何在微服务架构下依然保证各服务间数据的一致性，在单数据源的情况下，我们可以依托数据库提供的事务能力来保证一致性，但微服务场景下存在多个数据源，当业务请求需要同时更新或修改多个数据源的数据时，如何保证这些数据同时修改成功或失败，就成了一个需要关注的问题。为了解决这个问题，诞生了很多基础理论，如 CAP定理、BASE 理论，以及 2PC、3PC 等强一致性事务理论。

## CAP 定理

CAP 是 Consistency 一致性、Availability 可用性、Partition Tolarance  分区容忍性 三者的缩写。

- 一致性：指在分布式系统中任何时候所获取到的数据都是符合预期的；
- 可用性：任何时刻非故障的节点都能在合理时间内返回响应；
- 分区容忍性：表示分布式系统出现 **网络分区** 后，依然能够继续提供服务；

CAP 定理指出在任何时候，一个涉及共享数据的分布式系统最多只能同时满足一致性、可用性和分区容忍性中的二者，即满足 CP、AP 或者 CA。实际上，由于分布式系统中存在网络通信，而网络是不可靠的，一定会存在分区的情况，所以 CA 在实际生产中是永远不成立的。
![一致性、可用性、分区容忍性相互关系](http://pic.tanzhang.work/blog/20221228161311.png)

- **满足 CP 的情况**：分布式系统需要满足一致性和分区容忍性的时候，就会丢失一定的可用性。相当于在分布式系统中数据的同步时间被无限延长，为了保证请求得到正确结果，只能让系统暂时停止对外服务，选择 CP 的情况适用于对数据一致性要求比较高的场景，例如银行等涉及金钱交易的业务。
- **满足 AP 的情况**：满足 AP 的情况会使系统丢失一定的一致性，相当于在分布式系统存在网络分区期间，依然正常对外提供服务，而请求得到的数据跟预期数据并不一致。选择 AP 的情况适用于对数据一致性要求不是很高，而对可用性要求较高的场景。

分布式系统设计的目的就是为了保证服务的可用性。尽管“分布式事务”的目的就是如何保证分布式系统数据的一致性，但“一致性”却不得不成为被牺牲的一方，在节点数量庞大的分布式系统中，如果一味的去保证一致性，就会导致系统可用性降低，分布式系统设计的意义也就不存在了。不过，牺牲“一致性”不代表就完全不要一致性了，我们依然可以通过其他方法来保证数据的“最终一致性”。

## BASE 理论

BASE 是 Basically Available 基本可用、Soft State 软状态、Eventual Consistency 最终一致性 三者的缩写。BASE 理论指出在即使无法做到 强一致性，也可以通过某些合适的方法来达到最终一致性。

- 基本可用：分布式系统在出现故障时，允许损失部分可用性，保障核心服务可用；
- 软状态：分布式系统的软状态指的就是 CAP 定理中的数据不一致的状态；
- 最终一致性：分布式系统中的数据在经过一定时间以后，可以达到预期的状态；

BASE 理论实际上就是对 CAP 中 AP 模式的补充，当系统中产生网络分区时，保障系统的可用性，在此期间对数据的修改无法同步，导致数据的不一致性，此时的系统就处于软装态模式；当分区故障修复以后，系统中的数据继续进行同步，从而达到最终一致的状态。

### 二阶段提交（2PC）

分布式事务算法中比较有名的是“二阶段提交”，用来保证分布式系统中的强一致性。

在满足二阶段提交的分布式系统中，存在一个节点作为 协调者，其他节点 作为参与者，协调者和参与者的通信分为两个阶段，这也是二阶段提交的名称由来，其过程如下图所示：


1. 准备提交阶段：协调者发起准备提交请求，参与者收到请求后首先完成准备提交的操作，这里的主准备提交操作，实际上是参与者将事务涉及到的数据修改都写入日志中，并在追加一条 commit record 记录，然后回复给协调者 prepared，如果写入失败则回复 non-prepared；（关于 commit record 如果不明白可以查看 [本地事务]() 篇）；
2. 

为什么要二阶段提交

而阶段提交的组成

1. 协调者
2. 参与者

二阶段提交的过程

1. 准备提交
2. 提交

二阶段提交存在的缺点

1. 单点问题
2. 一致性问题
3. 延迟问题

### 三阶段提交

为什么要三阶段提交

三阶段提交的组成

1. 协调者
2. 参与者

三阶段提交的过程

1. 询问阶段
2. 准备提交阶段
3. 提交阶段

三阶段提交存在的问题
