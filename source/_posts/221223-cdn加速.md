---
title: 使用CDN为博客加速
author: 青蛙瓷器
img: 'http://pic.tanzhang.work/blog/gallary/221223.jpg!up.webp'
top: false
cover: false
toc: true
mathjax: false
categories: 博客
tags:
  - cdn
abbrlink: ee8d51c7
date: 2022-12-23 15:28:40
coverImg:
---
上一篇文章 [个人博客搭建流程](https://www.tanzhang.work/article/72cc96f6.html) 中我们讲到使用 github pages 可以很方便的搭建静态博客，但是存在访问速度慢的问题，本章我们来讲一下如何通过 cdn 来解决这个问题。

CDN（Content Distribution Network，内容分发网络）是一种十分透明的应用，它为互联网站点提供分流功能。假设你现在需要购买一台苹果手机，你不应该坐飞机到美国苹果公司的总部去购买，而应该直接到就近的苹果专卖店或零售商进行购买。cdn 的作用就跟专卖店或零售商类似，它为你提供目标站点的就近的访问地址，以此来加速你对网站的访问。

仅从网络传输的角度看，一个互联网系统的速度取决于以下四点因素：

- 服务器接入网络运营商的链路所能提供的出口带宽。
- 客户端接入网络运营商的链路所能提供的入口带宽。
- 从网站到用户之间经过的不同运营商之间互联节点的带宽，一般来说两个运营商之间只有固定的若干个点是互通的，所有跨运营商之间的交互都要经过这些点。
- 从网站到用户之间的物理链路传输时延。爱打游戏的同学应该都清楚，延迟（Ping 值）比带宽更重要。

以上四个网络问题，除了第二点只能通过换一个好点的宽带解决以外，其余问题都可以通过内容分发网络来解决。

内容分发网络的工作过程，主要涉及路由解析、内容分发、负载均衡和 CDN 应用，这里我们主要讨论下**路由解析**和**内容分发**的工作过程。

## 路由解析

在没有使用 CDN 的情况下，假设需要访问站点 www.baidu.com ，一次针对该域名的 DNS 解析过程如下图所示：
![DNS服务器解析域名过程](http://pic.tanzhang.work/blog/20221223181046.png!up.webp)

客户请求首先会访问距离自己**最近的 DNS 服务器**查询目标域名对应的服务器 ip，如果该 DNS 服务器知道该 ip，则直接返回给客户端，否则该 DNS 服务器会请求根域 DNS 服务器尝试获取目标 ip。

**根域**保存了顶级域 com、cn 等 DNS 服务器的信息，虽然它没有保存 www.baidu.com 这个域名，但根据域名结构可以判断这个域名属于 com 域，因此根域会返回它所管理的 com 域的 ip 地址，意思是“虽然我不知道你要查的那个域名的地址，但是你可以去 com 域看看”，最近的 DNS 服务器收到消息后会继续向 com 域的 DNS 服务器发送查询消息。

类似的，上级 DNS 服务器都保存了下级 DNS 服务器的信息，所以我们可以从根域开始从上往下顺藤摸瓜往下查找，直到找到目标 DNS 服务器，查询到目标域名的 ip 地址。

### 引入 CDN 后 DNS 的解析过程

在 CDN 介入以后，DNS 解析情况发生了变化。DNS 服务器为 www.baidu.com 的查询结果先返回了一个 CNAME，这个 CNAME 就是 CDN 服务的专属域名，然后回再继续查询这个 CNAME 所对应的 ip，这个过程可能得到多个 ip 地址，这些 ip 地址就是位于全国各地，存有本站缓存的 CDN 节点。

由于解析这个 CNAME 的权威服务器只能是由该 CDN 服务商所架设的权威 DNS，这个 DNS 服务将根据一定的均衡策略和参数，如拓扑结构、容量、时延等，在全国各地能提供服务的 CDN 缓存节点中挑选一个最适合的，将它的 IP 代替源站的 IP 地址，返回给本地 DNS。

浏览器拿到该 ip 地址后，会将其当作源站来进行访问。

## 内容分发

在 DNS 服务器的协助下，CDN 对于用户和服务器都可以是透明的。在用户不知情的情况下，CDN 服务器代替用户向源站发起请求，将获取到的资源缓存在自身服务器当中。既然 CDN 服务器起到了缓存的作用，那如何 **获取** 和 **更新** 缓存就成了一个需要关注的问题。

### 资源获取

CDN 获取源站资源的过程被称为“内容分发”，即将源站资源分发到不同的缓存节点当中。目前主要有以下两种内容分发的方式：

- 主动分发：主动分发由源站发起，将资源推送到各个 CDN 节点上，由于需要源站、CDN 服务双方提供 API 接口层面的配合，所以它对源站并不是透明的，仅对用户侧透明；主动分发通常适用于网站需要预载大量资源的场景。
- 被动回源：被动回源是由用户所触发的双向透明、全自动的资源缓存过程。当某个资源首次被用户请求，CDN 节点发现自己没有该资源，就向源站发起请求获取。这时请求的响应时间可以粗略的认为是资源从源站到 CDN 节点，再加上资源从 CDN 节点到用户的时间之和，从这点上看被动回源的首次访问时间通常是比较慢的，不适合数据量较大的场景。
  被动回源的优点是双向透明，不需要源站在程序上做任何的配合，使用起来非常方便，是小型站点使用 CDN 服务的主流选择。

### 资源更新

CDN 对于缓存资源的更新并没有统一的标准。尽管在 Http 协议中，Header 定义中包含了对 CDN 这类共享缓存的指引性参数，例如 Cache-Control 的 s-maxage，但是否遵循完全要取决于 CDN 本身的实现策略。因此，CDN 缓存的管理并不存在通用的准则。

目前最常见的作法是被动失效与手动失效结合，被动失效是指超过一定时间以后缓存便失效，下一次请求时便需要重新回源。而手动失效是指 CDN 服务商会提供 API 接口，用于手动调用将缓存过期。

## 又拍云CDN

又拍云 CDN 提供每月 15GB 免费流量（http 和 https 均可用），以及每月 10GB 免费云存储空间，开发者只要申请加入 [又拍云联盟](https://www.upyun.com/league) 即可获得。

申请通过后，进入又拍云控制台，选择创建 CDN 服务，如下图所示：
![点击创建 CDN 服务](http://pic.tanzhang.work/blog/20221224170222.png!up.webp)

按照要求进行填写即可：
![CDN 服务配置](http://pic.tanzhang.work/blog/20221224171030.png!up.webp)

- 服务名称可以随意填写；
- 加速域名为访问博客网站使用的域名，如笔者域名 www.tanzhang.work （加速域名需要先进行备案，一般域名注册网站都会提供备案功能，例如 [阿里云备案](https://beian.aliyun.com/?spm=5176.23076750.J_3207526240.11.56a11abewdhsVw) 和 [腾讯云备案](https://cloud.tencent.com/product/ba)）；
- 应用场景选择网页图片即可，静态博客资源均为网页图片类的静态资源；
- 回源协议需要选择 https，github pages 默认使用的是 https 协议；
- 源站证书校验需要设置为关闭；
- 源站地址即为 github pages 分配的默认地址，如笔者的博客地址 yutanzhang.github.io，https默认端口为443；

完成后点击右下角创建即可。

CDN 服务创建完成后会自动分配一个 CNAME，如下图所示：
![CDN 服务 CNAME](http://pic.tanzhang.work/blog/20221224172559.png!up.webp)

这个 CNAME 是一个特殊域名，只有 CDN 服务商的权威 DNS 服务器才能够解析成功。在上一篇文章 [个人博客搭建流程](https://www.tanzhang.work/article/72cc96f6.html) 中，我们将博客域名的解析记录值配置为 github pages 的默认地址，如下图所示：
![原 DNS 解析设置](http://pic.tanzhang.work/blog/20221221144804.png!up.webp)

在引入 CDN 后这里的记录值需要修改为 CDN 服务的 CNAME，修改后博客域名通过 DNS 解析得到的结果就变成了 CDN 服务的地址，实现访问加速。

## 总结

CDN 最初被设计出来的目的就是用来分发静态资源，给网站访问进行提速的。但是经过长时间的发展以后，CDN 能做的事情已经远不局限于加速静态资源这么简单，包括 安全防御、协议升级、状态缓存、资源修改、访问控制、注入功能，还可以用来绕过某些网络措施等，所涉及的功能众多，感兴趣的朋友可以单独去了解，这里便不再赘述。
